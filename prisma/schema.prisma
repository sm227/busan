generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int                @id @default(autoincrement())
  nickname         String             @unique
  password         String
  coinBalance      Int                @default(0) @map("coin_balance")
  role             String             @default("user") // user, instructor, admin
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @default(now()) @updatedAt @map("updated_at")
  bookmarks        Bookmark[]
  commentLikes     CommentLike[]
  comments         Comment[]
  guestbooks       Guestbook[]
  guestbookLikes   GuestbookLike[]
  surveyResults    SurveyResult[]
  userBadges       UserBadge[]
  userLikes        UserLike[]
  userProperties   UserProperty[]
  coinPurchases    CoinPurchase[]
  coinTransactions CoinTransaction[]
  instructorClasses OneDayClass[]     @relation("InstructorClasses")
  classEnrollments  ClassEnrollment[] @relation("UserEnrollments")
  classLikes        ClassLike[]       @relation("UserClassLikes")
  classBookmarks    ClassBookmark[]   @relation("UserClassBookmarks")
  classReviews      ClassReview[]     @relation("UserClassReviews")
  chatMessages     ChatMessage[]

  @@index([nickname])
  @@map("users")
}

model SurveyResult {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  occupation   String?
  livingStyle  String   @map("living_style")
  socialStyle  String   @map("social_style")
  workStyle    String   @map("work_style")
  hobbyStyle   String   @map("hobby_style")
  pace         String
  budget       String
  createdAt    DateTime @default(now()) @map("created_at")
  purchaseType String   @map("purchase_type")
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("survey_results")
}

model UserLike {
  id               Int      @id @default(autoincrement())
  userId           Int      @map("user_id")
  propertyId       String   @map("property_id")
  propertyTitle    String   @map("property_title")
  propertyLocation String   @map("property_location")
  propertyPrice    Int?     @map("property_price")
  matchScore       Int?     @map("match_score")
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation(fields: [userId], references: [id])

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
  @@map("user_likes")
}

model Guestbook {
  id             Int             @id @default(autoincrement())
  userId         Int             @map("user_id")
  title          String
  content        String
  location       String?
  rating         Int?
  category       String
  propertyId     String?         @map("property_id")
  tags           String?
  occupationTag  String?         @map("occupation_tag")
  hobbyStyleTag  String?         @map("hobby_style_tag")
  likesCount     Int             @default(0) @map("likes_count")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @default(now()) @updatedAt @map("updated_at")
  bookmarks      Bookmark[]
  comments       Comment[]
  user           User            @relation(fields: [userId], references: [id])
  guestbookLikes GuestbookLike[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@index([occupationTag])
  @@index([hobbyStyleTag])
  @@index([category, occupationTag])
  @@index([category, hobbyStyleTag])
  @@map("guestbook")
}

model GuestbookLike {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  guestbookId Int       @map("guestbook_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  guestbook   Guestbook @relation(fields: [guestbookId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([userId, guestbookId])
  @@index([userId])
  @@index([guestbookId])
  @@map("guestbook_likes")
}

model Comment {
  id           Int           @id @default(autoincrement())
  guestbookId  Int           @map("guestbook_id")
  userId       Int           @map("user_id")
  content      String
  parentId     Int?          @map("parent_id")
  likesCount   Int           @default(0) @map("likes_count")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @default(now()) @updatedAt @map("updated_at")
  commentLikes CommentLike[]
  guestbook    Guestbook     @relation(fields: [guestbookId], references: [id])
  parent       Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies      Comment[]     @relation("CommentReplies")
  user         User          @relation(fields: [userId], references: [id])

  @@index([guestbookId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  commentId Int      @map("comment_id")
  createdAt DateTime @default(now()) @map("created_at")
  comment   Comment  @relation(fields: [commentId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_likes")
}

model Bookmark {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  guestbookId Int       @map("guestbook_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  guestbook   Guestbook @relation(fields: [guestbookId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([userId, guestbookId])
  @@map("bookmarks")
}

model Badge {
  id             String      @id
  name           String
  description    String
  icon           String
  category       String
  conditionType  String      @map("condition_type")
  conditionValue Int         @map("condition_value")
  createdAt      DateTime    @default(now()) @map("created_at")
  userBadges     UserBadge[]

  @@index([category])
  @@index([conditionType])
  @@map("badges")
}

model UserBadge {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")
  badge    Badge    @relation(fields: [badgeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

// ==================== 마을 및 추천 (기존) ====================

model Village {
  id            String   @id
  title         String
  district      String
  city          String
  region        String?
  rent          Int?
  sale          Int?
  deposit       Int?
  rooms         Int
  size          Int
  type          String
  yearBuilt     Int?
  condition     String
  images        Json
  features      Json
  surroundings  Json
  communityInfo Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([district])
  @@index([city])
}

model Recommendation {
  id             String   @id @default(cuid())
  userId         Int?
  villageId      String
  title          String
  district       String
  city           String
  region         String?
  rent           Int
  sale           Int?
  deposit        Int?
  rooms          Int
  size           Int
  type           String
  yearBuilt      Int?
  condition      String
  images         Json
  features       Json
  surroundings   Json
  communityInfo  Json
  aiReason       String?
  createdAt      DateTime @default(now())
  contact        String?
  isUserProperty Boolean? @default(false) @map("is_user_property")
  matchScore     Int?     @map("match_score")
  userNickname   String?  @map("user_nickname")

  @@index([userId])
  @@index([villageId])
}

model UserProperty {
  id          String          @id @default(cuid())
  userId      Int             @map("user_id")
  title       String
  description String
  district    String
  city        String
  region      String?
  address     String?
  rent        Int?
  sale        Int?
  deposit     Int?
  rooms       Int
  size        Int
  type        String
  yearBuilt   Int?
  condition   String
  features    Json            @default("[]")
  contact     String
  status      String          @default("active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @default(now()) @updatedAt @map("updated_at")
  images      PropertyImage[]
  user        User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([district])
  @@index([city])
  @@index([createdAt])
  @@map("user_properties")
}

model PropertyImage {
  id         String       @id @default(cuid())
  propertyId String       @map("property_id")
  url        String
  order      Int          @default(0)
  isPrimary  Boolean      @default(false) @map("is_primary")
  createdAt  DateTime     @default(now()) @map("created_at")
  property   UserProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([propertyId, order])
  @@map("property_images")
}

// ==================== 코인 시스템 ====================

model CoinPurchase {
  id              String   @id @default(cuid())
  userId          Int      @map("user_id")
  amount          Int      // 구매한 코인 개수
  bonusAmount     Int      @default(0) @map("bonus_amount") // 보너스 코인 개수
  price           Int      // 결제 금액 (원)
  paymentMethod   String?  @map("payment_method") // 결제 수단
  paymentStatus   String   @default("completed") @map("payment_status") // completed, pending, failed
  transactionId   String?  @unique @map("transaction_id") // 결제 시스템의 거래 ID
  createdAt       DateTime @default(now()) @map("created_at")
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([paymentStatus])
  @@map("coin_purchases")
}

model CoinTransaction {
  id            String   @id @default(cuid())
  userId        Int      @map("user_id")
  amount        Int      // 증가(양수) 또는 감소(음수)
  type          String   // purchase, ad_reward, usage, bonus, refund
  description   String   // 거래 설명
  relatedId     String?  @map("related_id") // 관련된 구매 ID 또는 사용처 ID
  balanceBefore Int      @map("balance_before") // 거래 전 잔액
  balanceAfter  Int      @map("balance_after") // 거래 후 잔액
  createdAt     DateTime @default(now()) @map("created_at")
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("coin_transactions")
}

// ==================== 원데이 클래스 시스템 ====================

model OneDayClass {
  id               String            @id @default(cuid())
  instructorId     Int               @map("instructor_id")
  title            String
  description      String            @db.Text
  category         String            // farming, crafts, cooking, culture, nature
  subCategory      String?           @map("sub_category")

  // 위치 정보
  province         String
  city             String
  district         String
  address          String?
  locationDetail   String?           @map("location_detail")

  // 난이도 & 대상
  difficulty       String            // beginner, intermediate, advanced
  minAge           Int?              @map("min_age")
  maxAge           Int?              @map("max_age")
  targetAudience   String?           @map("target_audience")

  // 가격 정보
  price            Int               // 코인 가격
  originalPrice    Int?              @map("original_price")

  // 이미지
  thumbnailUrl     String?           @map("thumbnail_url")
  imageUrls        Json?             @map("image_urls")

  // 클래스 정보
  duration         Int               // 분 단위
  materials        Json?             // 준비물 배열
  includes         Json?             // 포함 사항 배열
  excludes         Json?             // 불포함 사항 배열
  prerequisites    String?           @db.Text

  // 통계 (비정규화)
  likesCount       Int               @default(0) @map("likes_count")
  bookmarksCount   Int               @default(0) @map("bookmarks_count")
  enrollmentsCount Int               @default(0) @map("enrollments_count")
  reviewsCount     Int               @default(0) @map("reviews_count")
  averageRating    Float             @default(0) @map("average_rating")

  // 상태
  status           String            @default("pending") // pending, approved, rejected, active, inactive
  rejectionReason  String?           @map("rejection_reason") @db.Text
  approvedAt       DateTime?         @map("approved_at")
  approvedBy       Int?              @map("approved_by")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Relations
  instructor       User              @relation("InstructorClasses", fields: [instructorId], references: [id])
  sessions         ClassSession[]
  enrollments      ClassEnrollment[]
  likes            ClassLike[]
  bookmarks        ClassBookmark[]
  reviews          ClassReview[]

  @@index([instructorId])
  @@index([category])
  @@index([province])
  @@index([city])
  @@index([difficulty])
  @@index([status])
  @@index([createdAt])
  @@index([averageRating])
  @@index([category, province])
  @@index([category, difficulty])
  @@map("oneday_classes")
}

model ClassSession {
  id              String            @id @default(cuid())
  classId         String            @map("class_id")
  sessionDate     DateTime          @map("session_date")
  startTime       String            @map("start_time") // HH:mm 형식
  endTime         String            @map("end_time")
  maxCapacity     Int               @map("max_capacity")
  currentEnrolled Int               @default(0) @map("current_enrolled")
  status          String            @default("open") // open, full, cancelled, completed
  notes           String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")

  // Relations
  class           OneDayClass       @relation(fields: [classId], references: [id], onDelete: Cascade)
  enrollments     ClassEnrollment[]

  @@index([classId])
  @@index([sessionDate])
  @@index([status])
  @@index([classId, sessionDate])
  @@map("class_sessions")
}

model ClassEnrollment {
  id               String        @id @default(cuid())
  userId           Int           @map("user_id")
  classId          String        @map("class_id")
  sessionId        String        @map("session_id")

  // 결제 정보
  paidAmount       Int           @map("paid_amount")
  transactionId    String        @map("transaction_id")

  // 상태
  status           String        @default("confirmed") // confirmed, cancelled, completed, noshow
  attendanceStatus String?       @map("attendance_status") // attended, absent, late

  // 참가자 정보
  participants     Int           @default(1)
  specialRequests  String?       @map("special_requests") @db.Text

  // 타임스탬프
  enrolledAt       DateTime      @default(now()) @map("enrolled_at")
  cancelledAt      DateTime?     @map("cancelled_at")
  completedAt      DateTime?     @map("completed_at")

  // Relations
  user             User          @relation("UserEnrollments", fields: [userId], references: [id])
  class            OneDayClass   @relation(fields: [classId], references: [id])
  session          ClassSession  @relation(fields: [sessionId], references: [id])
  review           ClassReview?

  @@unique([userId, sessionId])
  @@index([userId])
  @@index([classId])
  @@index([sessionId])
  @@index([status])
  @@index([enrolledAt])
  @@map("class_enrollments")
}

model ClassLike {
  id        String      @id @default(cuid())
  userId    Int         @map("user_id")
  classId   String      @map("class_id")
  createdAt DateTime    @default(now()) @map("created_at")

  user      User        @relation("UserClassLikes", fields: [userId], references: [id])
  class     OneDayClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@index([userId])
  @@index([classId])
  @@map("class_likes")
}

model ClassBookmark {
  id        String      @id @default(cuid())
  userId    Int         @map("user_id")
  classId   String      @map("class_id")
  createdAt DateTime    @default(now()) @map("created_at")

  user      User        @relation("UserClassBookmarks", fields: [userId], references: [id])
  class     OneDayClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@index([userId])
  @@index([classId])
  @@map("class_bookmarks")
}

model ClassReview {
  id                String          @id @default(cuid())
  enrollmentId      String          @unique @map("enrollment_id")
  userId            Int             @map("user_id")
  classId           String          @map("class_id")

  // 리뷰 내용
  rating            Int             // 1-5
  title             String?
  content           String          @db.Text
  images            Json?

  // 세부 평가 (선택)
  instructorRating  Int?            @map("instructor_rating")
  contentRating     Int?            @map("content_rating")
  facilityRating    Int?            @map("facility_rating")
  valueRating       Int?            @map("value_rating")

  // 태그
  tags              Json?

  // 통계
  helpfulCount      Int             @default(0) @map("helpful_count")

  // 상태
  isReported        Boolean         @default(false) @map("is_reported")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  enrollment        ClassEnrollment @relation(fields: [enrollmentId], references: [id])
  user              User            @relation("UserClassReviews", fields: [userId], references: [id])
  class             OneDayClass     @relation(fields: [classId], references: [id])

  @@index([userId])
  @@index([classId])
  @@index([rating])
  @@index([createdAt])
  @@map("class_reviews")
}

// ==================== 채팅 시스템 ====================

model ChatRoom {
  id          String        @id @default(cuid())
  name        String        // 채팅방 이름 (예: "원격근무러 모임")
  description String?       // 채팅방 설명
  category    String        // occupation, hobby, region
  categoryTag String        @map("category_tag") // 구체적인 카테고리 값 (예: "원격근무", "등산", "강원도")
  icon        String?       // 아이콘 이미지 URL 또는 이모지
  isActive    Boolean       @default(true) @map("is_active") // 활성화 여부
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @default(now()) @updatedAt @map("updated_at")
  messages    ChatMessage[]

  @@index([category])
  @@index([categoryTag])
  @@index([isActive])
  @@map("chat_rooms")
}

model ChatMessage {
  id         String   @id @default(cuid())
  roomId     String   @map("room_id")
  userId     Int      @map("user_id")
  content    String   // 메시지 내용
  isSystem   Boolean  @default(false) @map("is_system") // 시스템 메시지 여부 (예: "XXX님이 입장했습니다")
  createdAt  DateTime @default(now()) @map("created_at")
  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@index([roomId])
  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}
