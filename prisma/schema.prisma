// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 사용자 및 인증 ====================

model User {
  id        Int      @id @default(autoincrement())
  nickname  String   @unique
  password  String   // 평문 저장
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  surveyResults   SurveyResult[]
  userLikes       UserLike[]
  guestbooks      Guestbook[]
  guestbookLikes  GuestbookLike[]
  comments        Comment[]
  commentLikes    CommentLike[]
  bookmarks       Bookmark[]
  userBadges      UserBadge[]
  userProperties  UserProperty[]

  @@index([nickname])
  @@map("users")
}

model SurveyResult {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  livingStyle String   @map("living_style")
  socialStyle String   @map("social_style")
  workStyle   String   @map("work_style")
  hobbyStyle  String   @map("hobby_style")
  pace        String
  budget      String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("survey_results")
}

model UserLike {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  propertyId      String   @map("property_id")
  propertyTitle   String   @map("property_title")
  propertyLocation String  @map("property_location")
  propertyPrice   Int?     @map("property_price")
  matchScore      Int?     @map("match_score")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
  @@map("user_likes")
}

// ==================== 커뮤니티 ====================

model Guestbook {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  title      String
  content    String
  location   String?
  rating     Int?
  category   String   // 'experience', 'review', 'tip', 'question'
  propertyId String?  @map("property_id")
  tags       String?  // JSON string
  likesCount Int      @default(0) @map("likes_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user           User            @relation(fields: [userId], references: [id])
  guestbookLikes GuestbookLike[]
  comments       Comment[]
  bookmarks      Bookmark[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@map("guestbook")
}

model GuestbookLike {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  guestbookId Int      @map("guestbook_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user      User      @relation(fields: [userId], references: [id])
  guestbook Guestbook @relation(fields: [guestbookId], references: [id])

  @@unique([userId, guestbookId])
  @@index([userId])
  @@index([guestbookId])
  @@map("guestbook_likes")
}

model Comment {
  id          Int      @id @default(autoincrement())
  guestbookId Int      @map("guestbook_id")
  userId      Int      @map("user_id")
  content     String
  parentId    Int?     @map("parent_id")
  likesCount  Int      @default(0) @map("likes_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  guestbook    Guestbook     @relation(fields: [guestbookId], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  parent       Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies      Comment[]     @relation("CommentReplies")
  commentLikes CommentLike[]

  @@index([guestbookId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  commentId Int      @map("comment_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id])
  comment Comment @relation(fields: [commentId], references: [id])

  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_likes")
}

model Bookmark {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  guestbookId Int      @map("guestbook_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user      User      @relation(fields: [userId], references: [id])
  guestbook Guestbook @relation(fields: [guestbookId], references: [id])

  @@unique([userId, guestbookId])
  @@map("bookmarks")
}

// ==================== 뱃지 시스템 ====================

model Badge {
  id             String   @id
  name           String
  description    String
  icon           String
  category       String   // 'explorer', 'social', 'contributor', 'achiever'
  conditionType  String   @map("condition_type") // 'guestbook_count', 'likes_received', 'likes_given', 'visit_count', 'property_liked'
  conditionValue Int      @map("condition_value")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  userBadges UserBadge[]

  @@index([category])
  @@index([conditionType])
  @@map("badges")
}

model UserBadge {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

// ==================== 마을 및 추천 (기존) ====================

model Village {
  id        String   @id // 마을 ID (villId)

  // 기본 정보
  title     String
  district  String   // 시도명
  city      String   // 시군구명
  region    String?  // 읍면동명

  // 가격 정보
  rent      Int?
  sale      Int?
  deposit   Int?

  // 상세 정보
  rooms     Int
  size      Int
  type      String
  yearBuilt Int?
  condition String

  // 이미지 (JSON 배열로 저장)
  images    Json

  // 특징 (JSON 배열로 저장)
  features  Json

  // 주변 환경 (JSON 객체로 저장)
  surroundings Json

  // 마을 정보 (JSON 객체로 저장)
  communityInfo Json

  // 생성/업데이트 시간
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([district])
  @@index([city])
}

model Recommendation {
  id        String   @id @default(cuid())
  userId    Int?
  villageId String   // 마을 ID (villId)

  // 기본 정보
  title     String
  district  String   // 시도명
  city      String   // 시군구명
  region    String?  // 읍면동명

  // 가격 정보
  rent      Int
  sale      Int?
  deposit   Int?

  // 상세 정보
  rooms     Int
  size      Int
  type      String
  yearBuilt Int?
  condition String

  // 이미지 (JSON 배열로 저장)
  images    Json

  // 특징 (JSON 배열로 저장)
  features  Json

  // 주변 환경 (JSON 객체로 저장)
  surroundings Json

  // 마을 정보 (JSON 객체로 저장)
  communityInfo Json

  // AI 추천 이유
  aiReason  String?

  // 매칭 점수 (0-100)
  matchScore Int?    @map("match_score")

  // 사용자 매물 여부
  isUserProperty Boolean? @default(false) @map("is_user_property")
  userNickname String? @map("user_nickname")
  contact String?

  // 생성 시간
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([villageId])
}

// ==================== 사용자 매물 (거래) ====================

model UserProperty {
  id        String   @id @default(cuid())
  userId    Int      @map("user_id")

  // 기본 정보
  title     String
  description String @db.Text
  district  String   // 시도명
  city      String   // 시군구명
  region    String?  // 읍면동명
  address   String?  // 상세 주소

  // 가격 정보
  rent      Int?
  sale      Int?
  deposit   Int?

  // 상세 정보
  rooms     Int
  size      Int      // 평수
  type      String   // 단독주택, 전원주택, 한옥 등
  yearBuilt Int?
  condition String   // 리모델링 필요, 양호, 최상

  // 특징 (JSON 배열로 저장)
  features  Json     @default("[]")

  // 연락처
  contact   String   // 전화번호

  // 판매 상태
  status    String   @default("active") // active, sold, pending

  // 생성/업데이트 시간
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])
  images PropertyImage[]

  @@index([userId])
  @@index([status])
  @@index([district])
  @@index([city])
  @@index([createdAt])
  @@map("user_properties")
}

model PropertyImage {
  id         String   @id @default(cuid())
  propertyId String   @map("property_id")
  url        String   // 이미지 URL
  order      Int      @default(0) // 순서
  isPrimary  Boolean  @default(false) @map("is_primary") // 대표 이미지
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  property UserProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([propertyId, order])
  @@map("property_images")
}
